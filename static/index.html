<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leopard Gecko Calculator Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .suggestions-list::-webkit-scrollbar { width: 6px; }
        .suggestions-list::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-800 transition-colors duration-300">

    <div class="absolute top-4 right-4 flex space-x-2">
        <button onclick="setLanguage('it')" class="px-3 py-1 bg-white border rounded hover:bg-emerald-50 focus:ring-2 ring-emerald-300 text-sm font-bold">üáÆüáπ IT</button>
        <button onclick="setLanguage('en')" class="px-3 py-1 bg-white border rounded hover:bg-blue-50 focus:ring-2 ring-blue-300 text-sm font-bold">üá¨üáß EN</button>
    </div>

    <div class="max-w-4xl mx-auto mt-10 p-6 bg-white rounded-xl shadow-xl">
        <h1 class="text-3xl font-bold text-center text-emerald-600 mb-8" data-i18n="mainTitle">üß¨ Gecko Genetics Pro</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <div class="p-4 bg-blue-50 rounded-lg border border-blue-100 relative">
                <h2 class="text-xl font-bold mb-2 text-blue-800" data-i18n="sireTitle">Morph Padre ‚ôÇ</h2>
                <div class="mb-2 text-sm text-gray-500" data-i18n="inputPlaceholder">Aggiungi tratti (es. Mack Snow...)</div>
                
                <div id="sireTags" class="flex flex-wrap gap-2 mb-2 min-h-[40px]"></div>

                <div class="relative">
                    <input type="text" id="sireInput" 
                        class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-400 outline-none" 
                        placeholder="..." autocomplete="off">
                    <ul id="sireSuggestions" class="suggestions-list hidden absolute z-10 w-full bg-white border border-gray-300 rounded mt-1 max-h-48 overflow-y-auto shadow-lg"></ul>
                </div>
            </div>

            <div class="p-4 bg-pink-50 rounded-lg border border-pink-100 relative">
                <h2 class="text-xl font-bold mb-2 text-pink-800" data-i18n="damTitle">Morph Madre ‚ôÄ</h2>
                <div class="mb-2 text-sm text-gray-500" data-i18n="inputPlaceholder">Aggiungi tratti (es. Enigma...)</div>

                <div id="damTags" class="flex flex-wrap gap-2 mb-2 min-h-[40px]"></div>

                <div class="relative">
                    <input type="text" id="damInput" 
                        class="w-full p-2 border rounded focus:ring-2 focus:ring-pink-400 outline-none" 
                        placeholder="..." autocomplete="off">
                    <ul id="damSuggestions" class="suggestions-list hidden absolute z-10 w-full bg-white border border-gray-300 rounded mt-1 max-h-48 overflow-y-auto shadow-lg"></ul>
                </div>
            </div>
        </div>

        <button onclick="calculate()" class="w-full mt-6 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-md flex justify-center items-center">
            <span data-i18n="calcButton">üß™ Calcola Probabilit√†</span>
        </button>

        <div id="loader" class="hidden mt-6 text-center">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600"></div>
            <p class="text-emerald-600 mt-2" data-i18n="loading">Calcolo in corso...</p>
        </div>

        <div id="output" class="hidden mt-8 space-y-6 fade-in">
            <div id="notesArea" class="hidden p-4 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 rounded">
                <h3 class="font-bold" data-i18n="notesTitle">‚ö†Ô∏è Note:</h3>
                <p id="notesText" class="text-sm"></p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-bold text-slate-700 mb-3 border-b pb-2" data-i18n="genoTitle">Genotipi Probabili</h3>
                    <ul id="genotypesList" class="space-y-2 text-sm"></ul>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-slate-700 mb-3 border-b pb-2" data-i18n="phenoTitle">Fenotipi (Visibili)</h3>
                    <ul id="phenotypesList" class="space-y-2 text-sm"></ul>
                </div>
            </div>
        </div>
    </div>

    <div id="attributeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-96 transform transition-all scale-100">
            <h3 data-i18n="modalTitle" class="text-xl font-bold mb-4 text-gray-800">Dettagli Morph</h3>
            <p id="modalMorphName" class="text-emerald-600 font-semibold mb-4 text-lg"></p>
            
            <div id="recessiveOptions" class="hidden space-y-3">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="radio" name="recType" value="visual" checked class="text-emerald-600 focus:ring-emerald-500">
                    <span data-i18n="optVisual">Visuale (Omozigote)</span>
                </label>
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="radio" name="recType" value="het" class="text-emerald-600 focus:ring-emerald-500">
                    <span data-i18n="optHet">Het (Eterozigote)</span>
                </label>
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="radio" name="recType" value="ph" class="text-emerald-600 focus:ring-emerald-500">
                    <span data-i18n="optPh">Possibile Het (PH)</span>
                </label>
                
                <div id="phPercentContainer" class="hidden pl-6">
                    <label class="block text-sm text-gray-600 mb-1" data-i18n="lblProb">Probabilit√† %</label>
                    <div class="flex space-x-2">
                        <select id="phPercentSelect" onchange="togglePhCustomInput()" class="w-full p-2 border rounded bg-gray-50">
                            <option value="66">66%</option>
                            <option value="50">50%</option>
                            <option value="33">33%</option>
                            <option value="25">25%</option>
                            <option value="custom" data-i18n="optCustom">Custom</option>
                        </select>
                        <input type="number" id="phCustomVal" class="hidden w-20 p-2 border rounded border-emerald-300" placeholder="%">
                    </div>
                </div>
            </div>

            <div id="linebreedOptions" class="hidden space-y-3">
                <label class="block text-sm text-gray-600 mb-1" data-i18n="lblSelection">Tipo di selezione</label>
                <select id="lineType" class="w-full p-2 border rounded bg-gray-50 mb-3">
                    <option value="line" data-i18n="optLine">Line (Standard)</option>
                    <option value="pure" data-i18n="optPure">Pure (Pura)</option>
                    <option value="cross" data-i18n="optCross">Cross (Outcross)</option>
                    <option value="percent" data-i18n="optPercent">Percentuale / Intensit√†</option>
                </select>

                <div id="linePercentContainer" class="hidden">
                    <label class="block text-sm text-gray-600 mb-1" data-i18n="lblPercent">Percentuale %</label>
                    <input type="number" id="linePercentVal" class="w-full p-2 border rounded" placeholder="Es. 50">
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-700" data-i18n="btnCancel">Annulla</button>
                <button onclick="confirmAddMorph()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded shadow" data-i18n="btnAdd">Aggiungi</button>
            </div>
        </div>
    </div>

    <script>
        // --- DIZIONARIO TRADUZIONI ---
        const translations = {
            it: {
                mainTitle: "üß¨ Gecko Genetics Pro",
                sireTitle: "Morph Padre ‚ôÇ",
                damTitle: "Morph Madre ‚ôÄ",
                inputPlaceholder: "Aggiungi tratti (es. Mack Snow...)",
                calcButton: "üß™ Calcola Probabilit√†",
                loading: "Calcolo in corso...",
                notesTitle: "‚ö†Ô∏è Note:",
                genoTitle: "Genotipi Probabili",
                phenoTitle: "Fenotipi (Visibili)",
                modalTitle: "Dettagli Morph",
                optVisual: "Visuale (Omozigote)",
                optHet: "Het (Eterozigote)",
                optPh: "Possibile Het (PH)",
                lblProb: "Probabilit√† %",
                optCustom: "Custom",
                lblSelection: "Tipo di selezione",
                optLine: "Line (Standard)",
                optPure: "Pure (Pura)",
                optCross: "Cross (Outcross)",
                optPercent: "Percentuale / Intensit√†",
                lblPercent: "Percentuale %",
                btnCancel: "Annulla",
                btnAdd: "Aggiungi",
                alertSelect: "Seleziona almeno un tratto genetico!",
                alertErr: "Errore di connessione al server!"
            },
            en: {
                mainTitle: "üß¨ Gecko Genetics Pro",
                sireTitle: "Sire Morph ‚ôÇ",
                damTitle: "Dam Morph ‚ôÄ",
                inputPlaceholder: "Add traits (e.g. Mack Snow...)",
                calcButton: "üß™ Calculate Outcomes",
                loading: "Calculating...",
                notesTitle: "‚ö†Ô∏è Notes:",
                genoTitle: "Probable Genotypes",
                phenoTitle: "Phenotypes (Visuals)",
                modalTitle: "Morph Details",
                optVisual: "Visual (Homozygous)",
                optHet: "Het (Heterozygous)",
                optPh: "Possible Het (PH)",
                lblProb: "Probability %",
                optCustom: "Custom",
                lblSelection: "Selection Type",
                optLine: "Line (Standard)",
                optPure: "Pure",
                optCross: "Cross (Outcross)",
                optPercent: "Percentage / Intensity",
                lblPercent: "Percentage %",
                btnCancel: "Cancel",
                btnAdd: "Add",
                alertSelect: "Please select at least one genetic trait!",
                alertErr: "Connection error with the server!"
            }
        };

        let currentLang = 'it';
        let allMorphs = []; 
        let currentSelection = null; 
        let activeInputContext = null; 
        let selectedGenes = { sire: [], dam: [] };

        // --- GESTIONE LINGUA ---
        function setLanguage(lang) {
            currentLang = lang;
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    if (el.tagName === 'INPUT' && el.getAttribute('placeholder')) {
                        el.placeholder = translations[lang][key];
                    } else if (el.tagName === 'OPTION') {
                        el.text = translations[lang][key];
                    } else {
                        el.innerText = translations[lang][key];
                    }
                }
            });
            // Aggiorna placeholder input
            document.getElementById('sireInput').placeholder = translations[lang].inputPlaceholder.replace('Aggiungi', 'Type to search').replace('Add', 'Type to search'); 
            document.getElementById('damInput').placeholder = translations[lang].inputPlaceholder.replace('Aggiungi', 'Type to search').replace('Add', 'Type to search'); 
        }

        // --- CARICAMENTO MORPH ---
        async function loadMorphs() {
            try {
                const res = await fetch('http://127.0.0.1:8000/morphs');
                allMorphs = await res.json();
            } catch (err) {
                console.error("Errore caricamento morphs:", err);
            }
        }
        
        // --- AUTOCOMPLETE ---
        function setupAutocomplete(inputId, listId, context) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);

            input.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                list.innerHTML = '';
                if (query.length < 2) {
                    list.classList.add('hidden');
                    return;
                }
                const matches = allMorphs.filter(m => 
                    m.name.toLowerCase().includes(query) || 
                    (m.synonyms && m.synonyms.toLowerCase().includes(query))
                );
                if (matches.length > 0) {
                    list.classList.remove('hidden');
                    matches.forEach(m => {
                        const li = document.createElement('li');
                        li.className = "p-2 hover:bg-emerald-50 cursor-pointer text-sm border-b last:border-0";
                        let label = m.name;
                        if (m.synonyms && m.synonyms.toLowerCase().includes(query)) {
                            label += ` <span class="text-xs text-gray-500">(${m.synonyms})</span>`;
                        }
                        li.innerHTML = label;
                        li.onclick = () => initiateSelection(m, context);
                        list.appendChild(li);
                    });
                } else {
                    list.classList.add('hidden');
                }
            });
            document.addEventListener('click', (e) => {
                if (e.target !== input) list.classList.add('hidden');
            });
        }

        // --- LOGICA MODALE ---
        function initiateSelection(morph, context) {
            document.getElementById(context + 'Input').value = '';
            document.getElementById(context + 'Suggestions').classList.add('hidden');

            const type = morph.type.toLowerCase();
            if (type.includes('recessive') || type.includes('linebreed') || type === 'ph') {
                openModal(morph, context);
            } else {
                addTag(context, morph.name, morph);
            }
        }

        function openModal(morph, context) {
            currentSelection = { morph, context };
            activeInputContext = context;

            document.getElementById('modalMorphName').innerText = morph.name;
            document.getElementById('recessiveOptions').classList.add('hidden');
            document.getElementById('linebreedOptions').classList.add('hidden');
            document.getElementById('phPercentContainer').classList.add('hidden');
            document.getElementById('linePercentContainer').classList.add('hidden');

            // Reset
            document.getElementById('phPercentSelect').value = '66';
            document.getElementById('phCustomVal').classList.add('hidden');
            document.getElementById('phCustomVal').value = '';
            document.getElementById('lineType').value = 'line';

            const type = morph.type.toLowerCase();

            if (type.includes('recessive')) {
                document.getElementById('recessiveOptions').classList.remove('hidden');
                document.querySelector('input[name="recType"][value="visual"]').checked = true;
            } else if (type.includes('linebreed')) {
                document.getElementById('linebreedOptions').classList.remove('hidden');
            }
            document.getElementById('attributeModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('attributeModal').classList.add('hidden');
            currentSelection = null;
        }

        // --- GESTIONE CAMPI DINAMICI NEL MODALE ---
        document.querySelectorAll('input[name="recType"]').forEach(el => {
            el.addEventListener('change', (e) => {
                const phDiv = document.getElementById('phPercentContainer');
                if (e.target.value === 'ph') phDiv.classList.remove('hidden');
                else phDiv.classList.add('hidden');
            });
        });

        function togglePhCustomInput() {
            const selectVal = document.getElementById('phPercentSelect').value;
            const customInput = document.getElementById('phCustomVal');
            
            if (selectVal === 'custom') {
                customInput.classList.remove('hidden');
                customInput.focus();
            } else {
                customInput.classList.add('hidden');
            }
        }

        document.getElementById('lineType').addEventListener('change', (e) => {
            const percDiv = document.getElementById('linePercentContainer');
            if (e.target.value === 'percent') percDiv.classList.remove('hidden');
            else percDiv.classList.add('hidden');
        });

        // --- CONFERMA AGGIUNTA TAG (Logic Updated) ---
        function confirmAddMorph() {
            if (!currentSelection) return;
            const { morph, context } = currentSelection;
            const type = morph.type.toLowerCase();
            let finalString = morph.name;

            if (type.includes('recessive')) {
                const recType = document.querySelector('input[name="recType"]:checked').value;
                if (recType === 'het') {
                    finalString = `Het ${morph.name}`;
                } else if (recType === 'ph') {
                    // Logic: % Poss Het Gene
                    const selectVal = document.getElementById('phPercentSelect').value;
                    let val = selectVal;
                    if (selectVal === 'custom') {
                        const customVal = document.getElementById('phCustomVal').value;
                        val = customVal && customVal > 0 ? customVal : '??';
                    }
                    finalString = `${val}% ph ${morph.name}`;
                }
            } else if (type.includes('linebreed')) {
                const lineType = document.getElementById('lineType').value;
                
                if (lineType === 'pure') {
                    finalString = `${morph.name}`;
                } else if (lineType === 'line') {
                    finalString = `${morph.name} Line`;
                } else if (lineType === 'cross') {
                    finalString = `${morph.name} Cross`;
                } else if (lineType === 'percent') {
                    const pVal = document.getElementById('linePercentVal').value || '50';
                    // Logic: % Gene (prima del nome)
                    finalString = `${pVal}% ${morph.name}`; 
                }
            }

            addTag(context, finalString, morph);
            closeModal();
        }

        // --- RENDER TAGS ---
        function addTag(context, label, morphObj) {
            selectedGenes[context].push(label);
            renderTags(context);
        }

        function removeTag(context, index) {
            selectedGenes[context].splice(index, 1);
            renderTags(context);
        }

        function renderTags(context) {
            const container = document.getElementById(context + 'Tags');
            container.innerHTML = '';
            selectedGenes[context].forEach((tagText, index) => {
                const tag = document.createElement('div');
                const colorClass = context === 'sire' 
                    ? 'bg-blue-100 text-blue-800 border-blue-200' 
                    : 'bg-pink-100 text-pink-800 border-pink-200';
                
                tag.className = `flex items-center px-3 py-1 rounded-full text-sm font-medium border ${colorClass} transition transform hover:scale-105`;
                tag.innerHTML = `
                    <span>${tagText}</span>
                    <button onclick="removeTag('${context}', ${index})" class="ml-2 text-gray-500 hover:text-red-500 focus:outline-none font-bold">&times;</button>
                `;
                container.appendChild(tag);
            });
        }

        // --- CALCOLO (CHIAMATA API) ---
        async function calculate() {
            const sireString = selectedGenes.sire.join(', ');
            const damString = selectedGenes.dam.join(', ');

            if (!sireString && !damString) {
                alert(translations[currentLang].alertSelect);
                return;
            }

            const loader = document.getElementById('loader');
            const output = document.getElementById('output');
            
            loader.classList.remove('hidden');
            output.classList.add('hidden');

            try {
                const response = await fetch('http://127.0.0.1:8000/calculate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sire: { morph: sireString },
                        dam: { morph: damString }
                    })
                });

                const data = await response.json();

                const genotypesList = document.getElementById('genotypesList');
                const phenotypesList = document.getElementById('phenotypesList');
                genotypesList.innerHTML = '';
                phenotypesList.innerHTML = '';

                data.genotypes.forEach(item => {
                    const li = document.createElement('li');
                    li.className = "flex justify-between items-center bg-gray-50 p-3 rounded border hover:bg-gray-100";
                    li.innerHTML = `<span class="font-medium">${item.morph}</span><span class="font-bold text-emerald-600">${item.probability}%</span>`;
                    genotypesList.appendChild(li);
                });

                data.phenotypes.forEach(item => {
                    const li = document.createElement('li');
                    li.className = "flex justify-between items-center bg-gray-50 p-3 rounded border hover:bg-gray-100";
                    li.innerHTML = `<span class="font-medium">${item.morph}</span><span class="font-bold text-emerald-600">${item.probability}%</span>`;
                    phenotypesList.appendChild(li);
                });

                if (data.notes && data.notes.length > 0) {
                    document.getElementById('notesArea').classList.remove('hidden');
                    document.getElementById('notesText').innerText = Array.isArray(data.notes) ? data.notes.join("\n") : data.notes;
                } else {
                    document.getElementById('notesArea').classList.add('hidden');
                }
                output.classList.remove('hidden');
            } catch (error) {
                alert(translations[currentLang].alertErr);
                console.error(error);
            } finally {
                loader.classList.add('hidden');
            }
        }

        // --- INIT ---
        loadMorphs();
        setupAutocomplete('sireInput', 'sireSuggestions', 'sire');
        setupAutocomplete('damInput', 'damSuggestions', 'dam');
        setLanguage('it'); 
    </script>
</body>
</html>